generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * =========================== Enums ===========================
 */
enum Gender {
  unisex
  men
  women
  other
}

enum OrderStatus {
  pending
  paid
  processing
  shipped
  delivered
  cancelled
  refunded
  partial_refund
}

enum ShipmentStatus {
  label_created
  pickup_scheduled
  in_transit
  out_for_delivery
  delivered
  exception
  returned
}

enum PaymentStatus {
  pending
  completed
  failed
  refunded
  partial_refund
}

enum OfferCondition {
  NEW
  OPEN_BOX
  TESTER
}

enum OfferAuth {
  SEALED
  STORE_BILL
  VERIFIED_UNKNOWN
}

enum LocationStatus {
  UNVERIFIED
  ACTIVE
  SUSPENDED
}

/**
 * =========================== Users & Addresses ===========================
 */
model User {
  id           String        @id @default(uuid())
  email        String        @unique @db.Citext
  phone        String?       @unique
  passwordHash String
  fullName     String
  avatarUrl    String?
  isSeller     Boolean       @default(false) // single-seller now; keep for future RBAC
  clubMember   Boolean       @default(false)
  clubVerified Boolean       @default(false)
  sellerId     String?
  seller       Seller?       @relation(fields: [sellerId], references: [id], onDelete: SetNull)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  deletedAt    DateTime?
  lastLogin    DateTime?
  addresses    UserAddress[]
  cart         Cart?
  reviews      Review[]
  orders       Order[]
  payments     Payment[]
  priceWatches PriceWatch[]

  @@index([createdAt])
  @@index([sellerId])
}

model EmailVerificationToken {
  id         String    @id @default(uuid())
  email      String    @db.Citext
  codeHash   String
  expiresAt  DateTime
  consumedAt DateTime?
  createdAt  DateTime  @default(now())

  @@index([email, createdAt])
}

model UserAddress {
  id         String   @id @default(uuid())
  user       User     @relation(fields: [userId], references: [id])
  userId     String
  label      String?
  isDefault  Boolean  @default(false)
  firstName  String
  lastName   String
  line1      String
  line2      String?
  city       String
  state      String
  postalCode String
  country    String   @default("India")
  phone      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([userId, isDefault])
}

/**
 * =========================== Catalog ===========================
 */
model Brand {
  id        String    @id @default(uuid())
  name      String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  products  Product[]
}

model Product {
  id          String             @id @default(uuid())
  slug        String             @unique
  title       String
  brand       Brand              @relation(fields: [brandId], references: [id])
  brandId     String
  gender      Gender
  notes       Json?
  description String?
  isActive    Boolean            @default(true)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  variants    ProductVariant[]
  media       ProductMedia[]
  aggr        ProductAggregates?
  reviews     Review[]

  @@index([isActive, updatedAt])
}

model ProductMedia {
  id        String  @id @default(uuid())
  product   Product @relation(fields: [productId], references: [id])
  productId String
  url       String
  alt       String?
  sortOrder Int     @default(0)
  isPrimary Boolean @default(false)
}

model ProductAggregates {
  product         Product @relation(fields: [productId], references: [id])
  productId       String  @id
  ratingAvg       Decimal @default(0) @db.Decimal(3, 2)
  ratingCount     Int     @default(0)
  reviewCount     Int     @default(0)
  lowPricePaise   Int?
  inStockVariants Int     @default(0)
}

model ProductVariant {
  id           String                @id @default(uuid())
  product      Product               @relation(fields: [productId], references: [id])
  productId    String
  sizeMl       Int
  sku          String                @unique
  mrpPaise     Int
  salePaise    Int?
  isActive     Boolean               @default(true)
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt
  inventory    Inventory?
  orderItems   OrderItem[]
  cartItems    CartItem[]
  priceHistory ProductPriceHistory[]
  priceWatches PriceWatch[]
  masterOffers MasterOffer[]
  liveOffer    LiveOffer?

  @@index([productId, sizeMl])
}

model Inventory {
  variant   ProductVariant @relation(fields: [variantId], references: [id])
  variantId String         @id
  stock     Int
  reserved  Int            @default(0)
  updatedAt DateTime       @updatedAt

  @@index([stock], map: "idx_inventory_stock")
}

/**
 * =========================== Reviews ===========================
 */
model Review {
  id        String   @id @default(uuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  product   Product  @relation(fields: [productId], references: [id])
  productId String
  rating    Int
  comment   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, productId])
  @@index([productId, createdAt])
}

/**
 * =========================== Cart ===========================
 */
model Cart {
  id         String     @id @default(uuid())
  user       User?      @relation(fields: [userId], references: [id])
  userId     String?    @unique
  guestToken String?    @unique
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  expiresAt  DateTime?
  items      CartItem[]
}

model CartItem {
  cart      Cart           @relation(fields: [cartId], references: [id])
  cartId    String
  variant   ProductVariant @relation(fields: [variantId], references: [id])
  variantId String
  quantity  Int
  addedAt   DateTime       @default(now())

  @@id([cartId, variantId])
}

/**
 * =========================== Orders (JSON address snapshots) ===========================
 */
model Order {
  id              String      @id @default(uuid())
  user            User?       @relation(fields: [userId], references: [id])
  userId          String?
  status          OrderStatus @default(pending)
  subtotalPaise   Int
  taxPaise        Int         @default(0)
  shippingPaise   Int         @default(0)
  discountPaise   Int         @default(0)
  totalPaise      Int
  billingAddress  Json
  shippingAddress Json
  notes           String?
  guestEmail      String?
  payment         Payment?    @relation("OrderPayment", fields: [paymentId], references: [id])
  paymentId       String?     @unique
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  items           OrderItem[]
  shipments       Shipment[]

  @@index([userId, createdAt])
}

model OrderItem {
  id               String          @id @default(uuid()) // surrogate PK for per-item shipment + tracking
  order            Order           @relation(fields: [orderId], references: [id])
  orderId          String
  variant          ProductVariant  @relation(fields: [variantId], references: [id])
  variantId        String
  productId        String
  sizeMl           Int
  unitPricePaise   Int
  quantity         Int
  lineTotalPaise   Int
  trackingNumber   String?         @unique
  sellerId         String?
  seller           Seller?         @relation(fields: [sellerId], references: [id], onDelete: SetNull)
  sellerLocationId String?
  sellerLocation   SellerLocation? @relation(fields: [sellerLocationId], references: [id], onDelete: SetNull)
  sellerOfferId    String?
  sellerOffer      MasterOffer?    @relation(fields: [sellerOfferId], references: [id], onDelete: SetNull)
  shipment         Shipment?

  @@index([orderId])
  @@index([variantId])
  @@index([sellerId])
  @@index([sellerLocationId])
}

/**
 * =========================== Shipments (1:1 per OrderItem) ===========================
 */
model Shipment {
  id             String         @id @default(uuid())
  order          Order          @relation(fields: [orderId], references: [id])
  orderId        String
  orderItem      OrderItem      @relation(fields: [orderItemId], references: [id])
  orderItemId    String         @unique
  provider       String
  trackingNumber String?        @unique
  courierName    String?
  status         ShipmentStatus @default(label_created)
  shippedAt      DateTime?
  deliveredAt    DateTime?
  labelUrl       String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  @@index([orderId, createdAt])
  @@index([status])
}

/**
 * =========================== Payments ===========================
 */
model Payment {
  id                String         @id @default(uuid())
  order             Order?         @relation("OrderPayment")
  user              User?          @relation(fields: [userId], references: [id])
  userId            String?
  provider          String // "Razorpay"
  providerOrderId   String?        @unique
  providerPaymentId String?        @unique
  method            String? // upi/card/netbanking/wallet
  amountPaise       Int
  status            PaymentStatus  @default(pending)
  transactionTs     DateTime?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  events            PaymentEvent[]
}

model PaymentEvent {
  id         String   @id @default(uuid())
  payment    Payment  @relation(fields: [paymentId], references: [id])
  paymentId  String
  provider   String
  eventId    String   @unique // idempotency key
  eventType  String
  payload    Json
  receivedAt DateTime @default(now())

  @@index([paymentId, receivedAt])
}

/**
 * =========================== Price tracking (optional but useful) ===========================
 */
model ProductPriceHistory {
  id         String         @id @default(uuid())
  variant    ProductVariant @relation(fields: [variantId], references: [id])
  variantId  String
  recordedAt DateTime       @default(now())
  pricePaise Int

  @@index([variantId, recordedAt])
}

model PriceWatch {
  id             String         @id @default(uuid())
  user           User           @relation(fields: [userId], references: [id])
  userId         String
  variant        ProductVariant @relation(fields: [variantId], references: [id])
  variantId      String
  thresholdPaise Int
  alertEnabled   Boolean        @default(true)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  @@unique([userId, variantId])
}

/**
 * =========================== Marketplace Sellers & Offers ===========================
 */
model Seller {
  id           String           @id @default(cuid())
  name         String
  displayName  String?
  email        String?
  phone        String?
  gstNumber    String?          @unique
  panNumber    String?          @unique
  isActive     Boolean          @default(true)
  rating       Decimal?         @db.Decimal(3, 2)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  locations    SellerLocation[]
  masterOffers MasterOffer[]
  orderItems   OrderItem[]
  users        User[]
  liveOffers   LiveOffer[]

  @@index([isActive])
}

model SellerLocation {
  id                  String         @id @default(cuid())
  sellerId            String
  label               String
  address1            String
  address2            String?
  city                String
  state               String
  pincode             String
  delhiveryPickupCode String         @unique
  delhiveryVerified   Boolean        @default(false)
  status              LocationStatus @default(UNVERIFIED)
  lastVerifiedAt      DateTime?
  failureCount24h     Int            @default(0)
  contactName         String?
  contactPhone        String?
  lat                 Float?
  lng                 Float?
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  seller              Seller         @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  offers              MasterOffer[]
  liveOffers          LiveOffer[]
  orderItems          OrderItem[]

  @@unique([sellerId, label])
  @@index([sellerId, pincode])
}

model MasterOffer {
  id               String         @id @default(cuid())
  sellerId         String
  sellerLocationId String
  variantId        String
  partnerSku       String?
  price            Int
  shipping         Int            @default(0)
  mrp              Int?
  stockQty         Int
  isActive         Boolean        @default(true)
  expiresAt        DateTime?
  condition        OfferCondition @default(NEW)
  authGrade        OfferAuth      @default(SEALED)
  effectivePrice   Int            @default(0)
  authRank         Int            @default(3)
  condRank         Int            @default(3)
  version          Int            @default(1)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  seller           Seller         @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  sellerLocation   SellerLocation @relation(fields: [sellerLocationId], references: [id], onDelete: Restrict)
  variant          ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  orderItems       OrderItem[]
  liveOffer        LiveOffer?

  @@unique([sellerId, sellerLocationId, variantId])
  @@index([variantId, isActive, stockQty, effectivePrice])
  @@index([sellerId])
  @@index([sellerLocationId])
  @@index([isActive, expiresAt])
}

model LiveOffer {
  id               String         @id @default(cuid())
  variantId        String         @unique
  offerId          String         @unique
  price            Int
  sellerId         String
  sellerLocationId String
  stockQtySnapshot Int
  condition        OfferCondition
  authGrade        OfferAuth
  computedAt       DateTime       @default(now())
  offer            MasterOffer    @relation(fields: [offerId], references: [id], onDelete: Cascade)
  variant          ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  seller           Seller         @relation(fields: [sellerId], references: [id], onDelete: Restrict)
  sellerLocation   SellerLocation @relation(fields: [sellerLocationId], references: [id], onDelete: Restrict)

  @@index([variantId])
  @@index([sellerId])
  @@index([sellerLocationId])
}
